# å­˜å‚¨åç«¯

## ğŸ“š ç›®å½•

- [å†…å­˜å­˜å‚¨ï¼ˆé»˜è®¤ï¼‰](#å†…å­˜å­˜å‚¨é»˜è®¤)
- [Redis å­˜å‚¨](#redis-å­˜å‚¨)
  - [æ–¹å¼ 1: è¿æ¥å­—ç¬¦ä¸²ï¼ˆæ¨èï¼‰](#æ–¹å¼-1-è¿æ¥å­—ç¬¦ä¸²æ¨è)
  - [æ–¹å¼ 2: ä½¿ç”¨ ioredis å®¢æˆ·ç«¯](#æ–¹å¼-2-ä½¿ç”¨-ioredis-å®¢æˆ·ç«¯)
  - [Redis é›†ç¾¤](#redis-é›†ç¾¤)
  - [Redis å“¨å…µ](#redis-å“¨å…µ)
- [è‡ªå®šä¹‰å­˜å‚¨åç«¯](#è‡ªå®šä¹‰å­˜å‚¨åç«¯)
  - [åŸºæœ¬æ¥å£](#åŸºæœ¬æ¥å£)
  - [ç¤ºä¾‹ï¼šPostgreSQL å­˜å‚¨](#ç¤ºä¾‹postgresql-å­˜å‚¨)
  - [ç¤ºä¾‹ï¼šMongoDB å­˜å‚¨](#ç¤ºä¾‹mongodb-å­˜å‚¨)
- [æ€§èƒ½å¯¹æ¯”](#æ€§èƒ½å¯¹æ¯”)
- [é€‰æ‹©å»ºè®®](#é€‰æ‹©å»ºè®®)

---

## å†…å­˜å­˜å‚¨ï¼ˆé»˜è®¤ï¼‰

å¿«é€Ÿã€ç®€å•ã€ä»…é™å•æœåŠ¡å™¨ã€‚

```javascript
const limiter = new RateLimiter({
  store: 'memory',
});
```

**ç‰¹ç‚¹**:
- âœ… æœ€å¿«çš„é€Ÿåº¦
- âœ… æ— å¤–éƒ¨ä¾èµ–
- âœ… é›¶é…ç½®
- âŒ ä»…é™å•æœåŠ¡å™¨
- âŒ æœåŠ¡å™¨é‡å¯ä¸¢å¤±æ•°æ®

**é€‚ç”¨åœºæ™¯**:
- å•æœºåº”ç”¨
- å¼€å‘å’Œæµ‹è¯•
- å°å‹æœåŠ¡

## Redis å­˜å‚¨

åˆ†å¸ƒå¼ã€æŒä¹…åŒ–ã€å¤šæœåŠ¡å™¨æ”¯æŒã€‚

### æ–¹å¼ 1: è¿æ¥å­—ç¬¦ä¸²ï¼ˆæ¨èï¼‰

```javascript
const limiter = new RateLimiter({
  store: 'redis://localhost:6379',
});
```

**ç‰¹ç‚¹**:
- âœ… æœ€ç®€æ´
- âœ… è‡ªåŠ¨åˆ›å»ºè¿æ¥
- âœ… å¼€ç®±å³ç”¨

### æ–¹å¼ 2: ä½¿ç”¨ ioredis å®¢æˆ·ç«¯

```javascript
const { RateLimiter, RedisStore } = require('rate-limit');
const Redis = require('ioredis');

const redis = new Redis({
  host: 'localhost',
  port: 6379,
  db: 0,
});

const limiter = new RateLimiter({
  store: new RedisStore({
    client: redis,
    prefix: 'rate-limit:', // é”®å‰ç¼€
    expiry: 3600, // é»˜è®¤è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
  }),
});
```

**ç‰¹ç‚¹**:
- âœ… å®Œå…¨æ§åˆ¶è¿æ¥
- âœ… æ”¯æŒè¿æ¥æ± 
- âœ… æ”¯æŒé«˜çº§é…ç½®

### æ–¹å¼ 3: Redis é›†ç¾¤

```javascript
const Redis = require('ioredis');
const { RedisStore } = require('rate-limit');

const cluster = new Redis.Cluster([
  { host: 'node1', port: 6379 },
  { host: 'node2', port: 6379 },
  { host: 'node3', port: 6379 },
]);

const limiter = new RateLimiter({
  store: new RedisStore({ client: cluster }),
});
```

### æ–¹å¼ 4: Redis Sentinel

```javascript
const Redis = require('ioredis');
const { RedisStore } = require('rate-limit');

const sentinel = new Redis({
  sentinels: [
    { host: 'sentinel1', port: 26379 },
    { host: 'sentinel2', port: 26379 },
    { host: 'sentinel3', port: 26379 },
  ],
  name: 'mymaster',
});

const limiter = new RateLimiter({
  store: new RedisStore({ client: sentinel }),
});
```

**ç‰¹ç‚¹**:
- âœ… é«˜å¯ç”¨
- âœ… è‡ªåŠ¨æ•…éšœè½¬ç§»
- âœ… é€‚åˆç”Ÿäº§ç¯å¢ƒ

## è‡ªå®šä¹‰å­˜å‚¨

å®ç°è‡ªå·±çš„å­˜å‚¨åç«¯ã€‚

```javascript
class CustomStore {
  async increment(key, windowMs) {
    // è¿”å› { count, resetTime }
  }
  
  async decrement(key) {
    // å¯é€‰ï¼šç”¨äº skipFailedRequests
  }
  
  async reset(key) {
    // å¯é€‰ï¼šæ‰‹åŠ¨é‡ç½®
  }
}

const limiter = new RateLimiter({
  store: new CustomStore(),
});
```

**å®ç°æ­¥éª¤**:

1. åˆ›å»ºä¸€ä¸ªç±»å®ç°å­˜å‚¨æ¥å£
2. å®ç° `increment()` æ–¹æ³•
3. ï¼ˆå¯é€‰ï¼‰å®ç° `decrement()` å’Œ `reset()` æ–¹æ³•
4. ä¼ é€’ç»™ RateLimiter

## å­˜å‚¨å¯¹æ¯”

| ç‰¹æ€§ | å†…å­˜å­˜å‚¨ | Redis | è‡ªå®šä¹‰ |
|------|---------|-------|--------|
| é€Ÿåº¦ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ |
| åˆ†å¸ƒå¼ | âŒ | âœ… | âœ… |
| æŒä¹…åŒ– | âŒ | âœ… | å¯é€‰ |
| é…ç½®å¤æ‚åº¦ | ä½ | ä¸­ | é«˜ |
| é€‚ç”¨åœºæ™¯ | å•æœº | åˆ†å¸ƒå¼ | ç‰¹æ®Šéœ€æ±‚ |

## é€‰æ‹©æŒ‡å—

### é€‰æ‹©å†…å­˜å­˜å‚¨

```javascript
// âœ… å¼€å‘ç¯å¢ƒ
// âœ… å•æœºåº”ç”¨
// âœ… æµ‹è¯•ç¯å¢ƒ
// âœ… æ— å¤–éƒ¨ä¾èµ–
```

### é€‰æ‹© Redis

```javascript
// âœ… åˆ†å¸ƒå¼ç³»ç»Ÿ
// âœ… å¤šæœåŠ¡å™¨éƒ¨ç½²
// âœ… ç”Ÿäº§ç¯å¢ƒ
// âœ… éœ€è¦æŒä¹…åŒ–
// âœ… å¾®æœåŠ¡æ¶æ„
```

### é€‰æ‹©è‡ªå®šä¹‰å­˜å‚¨

```javascript
// âœ… ç‰¹æ®Šæ•°æ®åº“ï¼ˆMongoDBã€MySQLç­‰ï¼‰
// âœ… éœ€è¦è‡ªå®šä¹‰é€»è¾‘
// âœ… ä¸ç°æœ‰ç³»ç»Ÿé›†æˆ
// âœ… ç‰¹æ®Šéœ€æ±‚
```

---

## æ€§èƒ½å¯¹æ¯”

### å…·ä½“æ€§èƒ½æ•°å€¼

åŸºäº 10,000 ä¸ªå¹¶å‘ç”¨æˆ·çš„æµ‹è¯•æ•°æ®ï¼š

| å­˜å‚¨ç±»å‹ | QPS | å“åº”å»¶è¿Ÿ | å†…å­˜å ç”¨ | æ•°æ®æŒä¹…åŒ– | åˆ†å¸ƒå¼æ”¯æŒ |
|---------|-----|---------|---------|-----------|-----------|
| **Memory** | 500,000+ | <0.1ms | 78 KB - 7.8 MB | âŒ å¦ | âŒ å¦ |
| **Redis** | 100,000+ | 1-3ms | ~50 KB | âœ… æ˜¯ | âœ… æ˜¯ |
| **Redis é›†ç¾¤** | 300,000+ | 2-5ms | ~50 KB | âœ… æ˜¯ | âœ… æ˜¯ |

**å†…å­˜å ç”¨è¯´æ˜**ï¼ˆ10,000ä¸ªç”¨æˆ·ï¼‰ï¼š
- **Memory**: 
  - å›ºå®šçª—å£ï¼š78 KBï¼ˆæ¯ä¸ªkey 8å­—èŠ‚ï¼‰
  - æ»‘åŠ¨çª—å£ï¼š7.8 MBï¼ˆæ¯ä¸ªkey 800å­—èŠ‚ï¼‰
- **Redis**: ~50 KBï¼ˆåºåˆ—åŒ–åçš„æ•°æ®ï¼‰

**QPSè¯´æ˜**ï¼š
- **Memory**: æœ¬åœ°å†…å­˜è®¿é—®ï¼Œæå¿«
- **Redis**: ç½‘ç»œå¾€è¿” + Rediså¤„ç†æ—¶é—´
- **Redis é›†ç¾¤**: éœ€è¦è·¯ç”±åˆ°æ­£ç¡®çš„èŠ‚ç‚¹

---

## é€‰æ‹©å»ºè®®

### é€‰æ‹©å†³ç­–æ ‘

```
å¼€å§‹
â”‚
â”œâ”€ æ˜¯å¦æ˜¯å•æœåŠ¡å™¨éƒ¨ç½²ï¼Ÿ
â”‚  â”œâ”€ æ˜¯ â†“
â”‚  â”‚  â”œâ”€ æ˜¯å¦éœ€è¦æ•°æ®æŒä¹…åŒ–ï¼Ÿ
â”‚  â”‚  â”‚  â”œâ”€ å¦ â†’ Memory å­˜å‚¨ â­ï¼ˆæœ€å¿«ï¼‰
â”‚  â”‚  â”‚  â””â”€ æ˜¯ â†’ Redis å­˜å‚¨
â”‚  â”‚  â””â”€
â”‚  â””â”€ å¦ï¼ˆå¤šæœåŠ¡å™¨ï¼‰â†“
â”‚     â”œâ”€ æœåŠ¡å™¨æ•°é‡ï¼Ÿ
â”‚     â”‚  â”œâ”€ 2-10å° â†’ Redis å­˜å‚¨ â­ï¼ˆæ ‡å‡†æ–¹æ¡ˆï¼‰
â”‚     â”‚  â””â”€ 10å°ä»¥ä¸Š â†’ Redis é›†ç¾¤ â­ï¼ˆé«˜å¯ç”¨ï¼‰
â”‚     â””â”€
â”‚
â””â”€ æ˜¯å¦éœ€è¦è·¨æœåŠ¡å…±äº«é™æµæ•°æ®ï¼Ÿ
   â”œâ”€ æ˜¯ â†’ Redis å­˜å‚¨ï¼ˆå¿…éœ€ï¼‰
   â””â”€ å¦ â†’ Memory å­˜å‚¨
```

### å…·ä½“åœºæ™¯é€‰æ‹©

#### åœºæ™¯1ï¼šä¸ªäººé¡¹ç›® / å°å‹åº”ç”¨

```javascript
// âœ… æ¨èï¼šMemory å­˜å‚¨
const limiter = new RateLimiter({
  store: 'memory',
});

// åŸå› ï¼š
// - å•æœåŠ¡å™¨éƒ¨ç½²
// - è¯·æ±‚é‡ä¸å¤§ï¼ˆ<10ä¸‡/å¤©ï¼‰
// - æ— éœ€æŒä¹…åŒ–
// - æ€§èƒ½æœ€ä½³
```

#### åœºæ™¯2ï¼šä¸­å°å‹ä¼ä¸šåº”ç”¨

```javascript
// âœ… æ¨èï¼šRedis å­˜å‚¨
const limiter = new RateLimiter({
  store: 'redis://localhost:6379',
});

// åŸå› ï¼š
// - å¯èƒ½æ‰©å±•åˆ°å¤šæœåŠ¡å™¨
// - éœ€è¦æ•°æ®æŒä¹…åŒ–
// - é‡å¯åä¸ä¸¢å¤±é™æµæ•°æ®
// - ä¾¿äºç›‘æ§å’Œè°ƒè¯•
```

#### åœºæ™¯3ï¼šå¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿ

```javascript
// âœ… æ¨èï¼šRedis é›†ç¾¤
const Redis = require('ioredis');
const { RedisStore } = require('flex-rate-limit');

const cluster = new Redis.Cluster([
  { host: 'node1', port: 6379 },
  { host: 'node2', port: 6379 },
  { host: 'node3', port: 6379 },
]);

const limiter = new RateLimiter({
  store: new RedisStore({ client: cluster }),
});

// åŸå› ï¼š
// - å¤šå°æœåŠ¡å™¨ï¼ˆ10+ï¼‰
// - é«˜å¹¶å‘ï¼ˆ100ä¸‡+ QPSï¼‰
// - éœ€è¦é«˜å¯ç”¨
// - æ•°æ®éœ€è¦æŒä¹…åŒ–
```

#### åœºæ™¯4ï¼šå¼€å‘å’Œæµ‹è¯•ç¯å¢ƒ

```javascript
// âœ… æ¨èï¼šMemory å­˜å‚¨
const limiter = new RateLimiter({
  store: 'memory',
});

// åŸå› ï¼š
// - æ— éœ€é¢å¤–ä¾èµ–ï¼ˆRedisï¼‰
// - å¿«é€Ÿå¯åŠ¨æµ‹è¯•
// - æ— éœ€é…ç½®
// - æ€§èƒ½æœ€å¥½
```

---

### ä¼ ç»Ÿé€‰æ‹©å»ºè®®ï¼ˆç®€åŒ–ç‰ˆï¼‰

### é€‰æ‹©å†…å­˜å­˜å‚¨

```javascript
const limiter = new RateLimiter({
  store: 'memory',
  algorithm: 'fixed-window', // æ›´å¿«
  windowMs: 60000,
  max: 100,
});
```

### Redis æ€§èƒ½ä¼˜åŒ–

```javascript
const redis = new Redis({
  retryStrategy: (times) => Math.min(times * 50, 2000),
  lazyConnect: true,
  maxRetriesPerRequest: 3,
});

const limiter = new RateLimiter({
  store: new RedisStore({
    client: redis,
    prefix: 'rl:', // ä½¿ç”¨çŸ­å‰ç¼€
  }),
});
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

**ç›¸å…³é…ç½®**ï¼š
- ğŸ“– [é…ç½®è¯¦è§£](./config.md) - storeé…ç½®é€‰é¡¹è¯´æ˜
- ğŸ“– [é«˜çº§ç”¨æ³•](./advanced.md) - è‡ªå®šä¹‰å­˜å‚¨åç«¯å®ç°

**æ€§èƒ½ä¼˜åŒ–**ï¼š
- ğŸ“– [ç®—æ³•æ·±åº¦åˆ†æ](./algorithms-deep-analysis.md) - æ€§èƒ½å¯¹æ¯”æ•°æ®å’Œä¼˜åŒ–å»ºè®®

**åŸºç¡€çŸ¥è¯†**ï¼š
- ğŸ“– [å¿«é€Ÿå¼€å§‹](./quickstart.md) - åŸºæœ¬ç”¨æ³•

**è¿”å›**ï¼š
- ğŸ“– [æ–‡æ¡£ä¸­å¿ƒ](./README.md) - æŸ¥çœ‹æ‰€æœ‰æ–‡æ¡£å’Œå­¦ä¹ è·¯å¾„






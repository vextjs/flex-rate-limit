# é…ç½®è¯¦è§£

## ğŸ“š ç›®å½•

- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [æ ¸å¿ƒé…ç½®é¡¹](#æ ¸å¿ƒé…ç½®é¡¹)
  - [1. windowMs - æ—¶é—´çª—å£ï¼ˆå¿…éœ€ï¼‰](#1-windowms---æ—¶é—´çª—å£å¿…éœ€)
  - [2. max - æœ€å¤§è¯·æ±‚æ•°ï¼ˆå¿…éœ€ï¼‰](#2-max---æœ€å¤§è¯·æ±‚æ•°å¿…éœ€)
  - [3. algorithm - é™æµç®—æ³•ï¼ˆå¯é€‰ï¼‰](#3-algorithm---é™æµç®—æ³•å¯é€‰)
  - [4. store - å­˜å‚¨åç«¯ï¼ˆå¯é€‰ï¼‰](#4-store---å­˜å‚¨åç«¯å¯é€‰)
  - [5. keyGenerator - é”®ç”Ÿæˆå™¨ï¼ˆå¯é€‰ï¼‰](#5-keygenerator---é”®ç”Ÿæˆå™¨å¯é€‰)
  - [6. å…¶ä»–é…ç½®é¡¹](#6-å…¶ä»–é…ç½®é¡¹)
- [å®Œæ•´é…ç½®ç¤ºä¾‹](#å®Œæ•´é…ç½®ç¤ºä¾‹)
- [å‚æ•°é€ŸæŸ¥è¡¨](#å‚æ•°é€ŸæŸ¥è¡¨)
- [å®æˆ˜é…ç½®åœºæ™¯](#å®æˆ˜é…ç½®åœºæ™¯)
  - [åœºæ™¯1ï¼šç™»å½•ä¿æŠ¤ï¼ˆä¸¥æ ¼é™åˆ¶ï¼‰](#åœºæ™¯1ç™»å½•ä¿æŠ¤ä¸¥æ ¼é™åˆ¶)
  - [åœºæ™¯2ï¼šæ•æ„Ÿæ“ä½œï¼ˆä¸­ç­‰é™åˆ¶ï¼‰](#åœºæ™¯2æ•æ„Ÿæ“ä½œä¸­ç­‰é™åˆ¶)
  - [åœºæ™¯3ï¼šæ•°æ®ä¿®æ”¹ï¼ˆæ™®é€šé™åˆ¶ï¼‰](#åœºæ™¯3æ•°æ®ä¿®æ”¹æ™®é€šé™åˆ¶)
  - [åœºæ™¯4ï¼šAPIæŸ¥è¯¢ï¼ˆå®½æ¾é™åˆ¶ï¼‰](#åœºæ™¯4apiæŸ¥è¯¢å®½æ¾é™åˆ¶)
  - [åœºæ™¯5ï¼šå…¬å¼€APIï¼ˆé«˜é¢‘é™åˆ¶ï¼‰](#åœºæ™¯5å…¬å¼€apié«˜é¢‘é™åˆ¶)
  - [åœºæ™¯6ï¼šç”¨æˆ·ç­‰çº§åˆ†çº§](#åœºæ™¯6ç”¨æˆ·ç­‰çº§åˆ†çº§)
  - [åœºæ™¯7ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿï¼ˆRedisï¼‰](#åœºæ™¯7åˆ†å¸ƒå¼ç³»ç»Ÿredis)
- [æ¨èé…ç½®é€ŸæŸ¥è¡¨](#æ¨èé…ç½®é€ŸæŸ¥è¡¨)
- [Redis å­˜å‚¨é…ç½®](#redis-å­˜å‚¨é…ç½®)

---

## å¿«é€Ÿå¼€å§‹

æœ€ç®€å•çš„é…ç½®ï¼š

```javascript
const { RateLimiter } = require('flex-rate-limit');

// é»˜è®¤é…ç½®ï¼š1åˆ†é’Ÿå†…æœ€å¤š100æ¬¡è¯·æ±‚
const limiter = new RateLimiter({
  windowMs: 60 * 1000,  // 1åˆ†é’Ÿ
  max: 100,             // æœ€å¤š100æ¬¡
});
```

âš ï¸ **é‡è¦æç¤º**ï¼š
- é»˜è®¤å€¼ `max: 100` ä»…ä½œä¸ºç¤ºä¾‹ï¼Œ**è¯·æ ¹æ®å®é™…ä¸šåŠ¡è°ƒæ•´**
- ç™»å½•ç­‰æ•æ„Ÿæ¥å£å»ºè®®è®¾ç½®ä¸º `5-10`
- å…¬å¼€APIå»ºè®®è®¾ç½®ä¸º `1000+`ï¼ˆé…åˆæ›´é•¿çš„æ—¶é—´çª—å£ï¼‰

---

## æ ¸å¿ƒé…ç½®é¡¹

### 1. windowMs - æ—¶é—´çª—å£ï¼ˆå¿…éœ€ï¼‰

**è¯´æ˜**ï¼šé™æµçš„æ—¶é—´èŒƒå›´ï¼ˆæ¯«ç§’ï¼‰

```javascript
windowMs: 60 * 1000        // 1åˆ†é’Ÿ = 60ç§’
windowMs: 15 * 60 * 1000   // 15åˆ†é’Ÿ
windowMs: 60 * 60 * 1000   // 1å°æ—¶
```

**æ¨èé…ç½®**ï¼š
- ç™»å½•/æ³¨å†Œï¼š`15 * 60 * 1000`ï¼ˆ15åˆ†é’Ÿï¼‰
- APIæŸ¥è¯¢ï¼š`60 * 1000`ï¼ˆ1åˆ†é’Ÿï¼‰
- æ•°æ®ä¿®æ”¹ï¼š`60 * 60 * 1000`ï¼ˆ1å°æ—¶ï¼‰

**é»˜è®¤å€¼**ï¼š`60000`ï¼ˆ1åˆ†é’Ÿï¼‰

---

### 2. max - æœ€å¤§è¯·æ±‚æ•°ï¼ˆå¿…éœ€ï¼‰

**è¯´æ˜**ï¼šåœ¨æ—¶é—´çª—å£å†…å…è®¸çš„æœ€å¤§è¯·æ±‚æ¬¡æ•°

```javascript
// æ–¹å¼1ï¼šå›ºå®šæ•°å­—
max: 5        // æœ€å¤š5æ¬¡
max: 100      // æœ€å¤š100æ¬¡

// æ–¹å¼2ï¼šåŠ¨æ€å‡½æ•°ï¼ˆæ ¹æ®ç”¨æˆ·ç­‰çº§ï¼‰
max: async (req) => {
  if (req.user?.vip) return 1000;  // VIPç”¨æˆ·
  return 100;                       // æ™®é€šç”¨æˆ·
}
```

**æ¨èé…ç½®**ï¼š
- ç™»å½•/æ³¨å†Œï¼š`5`ï¼ˆä¸¥æ ¼é™åˆ¶ï¼Œé˜²æš´åŠ›ç ´è§£ï¼‰â­â­â­
- æ•æ„Ÿæ“ä½œï¼š`10`ï¼ˆä¿®æ”¹å¯†ç ã€æ”¯ä»˜ç­‰ï¼‰
- æ•°æ®ä¿®æ”¹ï¼š`50`ï¼ˆåˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ï¼‰
- APIæŸ¥è¯¢ï¼š`100`ï¼ˆåˆ—è¡¨ã€è¯¦æƒ…ç­‰ï¼‰
- é«˜é¢‘æŸ¥è¯¢ï¼š`200-500`ï¼ˆæœç´¢ã€ç»Ÿè®¡ç­‰ï¼‰
- å…¬å¼€APIï¼š`1000+`ï¼ˆå¼€æ”¾æ¥å£ï¼‰

**é»˜è®¤å€¼**ï¼š`100`ï¼ˆä»…ä½œç¤ºä¾‹ï¼Œè¯·æ ¹æ®ä¸šåŠ¡è°ƒæ•´ï¼‰

---

### 3. algorithm - é™æµç®—æ³•ï¼ˆå¯é€‰ï¼‰

**è¯´æ˜**ï¼šé€‰æ‹©é™æµç®—æ³•ï¼Œä¸åŒç®—æ³•æœ‰ä¸åŒç‰¹æ€§

```javascript
algorithm: 'sliding-window'  // æ»‘åŠ¨çª—å£ï¼ˆé»˜è®¤ï¼Œæ¨èï¼‰
algorithm: 'fixed-window'    // å›ºå®šçª—å£ï¼ˆé«˜å¹¶å‘ï¼‰
algorithm: 'token-bucket'    // ä»¤ç‰Œæ¡¶ï¼ˆå…è®¸çªå‘ï¼‰
algorithm: 'leaky-bucket'    // æ¼æ¡¶ï¼ˆå¹³æ»‘æµé‡ï¼‰
```

**é»˜è®¤å€¼**ï¼š`'sliding-window'`ï¼ˆæœ€ç²¾ç¡®ï¼‰

#### å¿«é€Ÿå¯¹æ¯”

| ç®—æ³• | ç²¾ç¡®åº¦ | å†…å­˜ | é€‚ç”¨åœºæ™¯ | æ¨èåº¦ | è¯¦ç»†æ–‡æ¡£ |
|------|--------|------|---------|--------|---------|
| **sliding-window** | â­â­â­â­â­ | é«˜ | APIé™æµã€ç™»å½•ä¿æŠ¤ | â­â­â­â­â­ | [ğŸ‘‰ è¯¦ç»†è¯´æ˜](#1-sliding-windowæ»‘åŠ¨çª—å£---é»˜è®¤æ¨è-) |
| **fixed-window** | â­â­ | ä½ | é«˜å¹¶å‘ã€ä½ç²¾åº¦ | â­â­â­ | [ğŸ‘‰ è¯¦ç»†è¯´æ˜](#2-fixed-windowå›ºå®šçª—å£---é«˜å¹¶å‘åœºæ™¯) |
| **token-bucket** | â­â­â­â­ | ä½ | APIç½‘å…³ã€å…è®¸çªå‘ | â­â­â­â­ | [ğŸ‘‰ è¯¦ç»†è¯´æ˜](#3-token-bucketä»¤ç‰Œæ¡¶---å…è®¸çªå‘) |
| **leaky-bucket** | â­â­â­â­ | ä½ | æµé‡æ•´å½¢ã€ä¿æŠ¤åç«¯ | â­â­â­â­ | [ğŸ‘‰ è¯¦ç»†è¯´æ˜](#4-leaky-bucketæ¼æ¡¶---å¹³æ»‘æµé‡) |

ğŸ’¡ **ç®—æ³•å¯¹æ¯”æ–‡æ¡£**ï¼š
- ğŸ“– [ç®—æ³•å¯¹æ¯”æŒ‡å—](./algorithms-comparison.md) - é€‰æ‹©å†³ç­–ã€é…ç½®ç¤ºä¾‹ã€å®æˆ˜æ¨è
- ğŸ“– [ç®—æ³•æ·±åº¦åˆ†æ](./algorithms-deep-analysis.md) - å®ç°åŸç†ã€ç¬æ—¶è¶…é¢‘åˆ†æã€æºç è§£è¯»

#### ç®—æ³•è¯¦è§£

**1. sliding-windowï¼ˆæ»‘åŠ¨çª—å£ï¼‰** - é»˜è®¤æ¨è â­â­â­â­â­

```javascript
// é…ç½®ï¼šwindowMs: 60000 (60ç§’), max: 100
```

**å·¥ä½œæ–¹å¼**ï¼š
- æ¯æ¬¡è¯·æ±‚éƒ½æ£€æŸ¥"å¾€å‰æ¨60ç§’"å†…çš„æ‰€æœ‰è¯·æ±‚æ•°
- ä»»æ„è¿ç»­60ç§’å†…ä¸¥æ ¼â‰¤100æ¬¡
- 0msæ—¶åˆ»100ä¸ªè¯·æ±‚å…¨éƒ¨å…è®¸ï¼Œç¬¬101ä¸ªæ‹’ç»
- 0msçš„è¯·æ±‚åœ¨60000msæ—¶è¿‡æœŸï¼Œæ­¤æ—¶å¯ä»¥å†å‘æ–°è¯·æ±‚

**ç‰¹ç‚¹**ï¼š
- âœ… æœ€ç²¾ç¡®ï¼šä»»æ„æ—¶åˆ»éƒ½ç²¾ç¡®é™åˆ¶
- âœ… æ— è¾¹ç•Œé—®é¢˜ï¼šä¸ä¼šå‡ºç°çª—å£åˆ‡æ¢æ—¶çš„è¶…é¢‘
- âœ… æ”¯æŒå¹¶å‘ï¼šç¬é—´100ä¸ªè¯·æ±‚å…¨éƒ¨å…è®¸ï¼ˆä¸æ˜¯"ä¸å…è®¸çªå‘"ï¼‰
- âŒ å†…å­˜å ç”¨é«˜ï¼šéœ€è¦å­˜å‚¨æ‰€æœ‰è¯·æ±‚æ—¶é—´æˆ³

**é€‚ç”¨**ï¼šAPIé™æµã€ç™»å½•ä¿æŠ¤ã€éœ€è¦ç²¾ç¡®æ§åˆ¶çš„åœºæ™¯

---

**2. fixed-windowï¼ˆå›ºå®šçª—å£ï¼‰** - é«˜å¹¶å‘åœºæ™¯

```javascript
// é…ç½®ï¼šwindowMs: 60000 (60ç§’), max: 100
```

**å·¥ä½œæ–¹å¼**ï¼š
- æ—¶é—´åˆ†ä¸ºå›ºå®šçš„çª—å£ï¼š[0-60s)ã€[60-120s)ã€[120-180s)...
- æ¯ä¸ªçª—å£å†…ç‹¬ç«‹è®¡æ•°ï¼Œæœ€å¤š100æ¬¡
- çª—å£åˆ‡æ¢æ—¶è®¡æ•°å™¨é‡ç½®ä¸º0

**è¾¹ç•Œé—®é¢˜ç¤ºä¾‹**ï¼š
```
çª—å£0 [0-60s):   59ç§’æ—¶å‘é€100æ¬¡ â†’ âœ… å…è®¸
çª—å£1 [60-120s): 60ç§’æ—¶å‘é€100æ¬¡ â†’ âœ… å…è®¸
ç»“æœï¼šè¿ç»­2ç§’å†…å‘é€äº†200æ¬¡ï¼ï¼ˆæœ¬åº”60ç§’å†…â‰¤100æ¬¡ï¼‰
```

**ç‰¹ç‚¹**ï¼š
- âœ… æœ€å¿«é€Ÿï¼šO(1)å¤æ‚åº¦ï¼Œå†…å­˜å ç”¨æœ€ä½
- âš ï¸ è¾¹ç•Œè¶…é¢‘ï¼šçª—å£äº¤ç•Œå¤„å¯èƒ½ç¬é—´å…è®¸2å€è¯·æ±‚ï¼ˆ200æ¬¡ï¼‰
- âš ï¸ ä¸ç²¾ç¡®ï¼šä¸ç¬¦åˆ"ä»»æ„è¿ç»­60ç§’"çš„è¯­ä¹‰

**é€‚ç”¨**ï¼š10ä¸‡+ QPSé«˜å¹¶å‘åœºæ™¯ï¼Œå¯æ¥å—è¾¹ç•Œè¶…é¢‘

---

**3. token-bucketï¼ˆä»¤ç‰Œæ¡¶ï¼‰** - å…è®¸çªå‘

```javascript
// é…ç½®ï¼šcapacity: 100, refillRate: 100 (æ¯ç§’100ä¸ª), windowMs: 1000
```

**å·¥ä½œæ–¹å¼**ï¼š
- æ¡¶åˆå§‹æœ‰100ä¸ªä»¤ç‰Œï¼ˆæ»¡ï¼‰
- æ¯ç§’è¡¥å……100ä¸ªä»¤ç‰Œï¼ˆæœ€å¤šè¡¥åˆ°100ï¼‰
- æ¯ä¸ªè¯·æ±‚æ¶ˆè€—1ä¸ªä»¤ç‰Œ
- æœ‰ä»¤ç‰Œå°±ç«‹å³å¤„ç†ï¼Œæ²¡æœ‰å°±æ‹’ç»

**å®é™…è¡¨ç°**ï¼š
```
åœºæ™¯ï¼šæ¡¶æ»¡æ—¶ç¬é—´å‘é€150ä¸ªè¯·æ±‚
0ms:    è¯·æ±‚1-100  â†’ ç«‹å³å¤„ç†ï¼ˆæ¶ˆè€—100ä»¤ç‰Œï¼Œæ¡¶ç©ºï¼‰âœ…
0ms:    è¯·æ±‚101-150 â†’ æ‹’ç»ï¼ˆæ— ä»¤ç‰Œï¼‰âŒ
10ms:   è¡¥å……1ä¸ªä»¤ç‰Œ
10ms:   è¯·æ±‚151    â†’ ç«‹å³å¤„ç† âœ…
```

**ä¸ sliding-window çš„åŒºåˆ«**ï¼š

| ç»´åº¦ | sliding-window | token-bucket |
|------|----------------|--------------|
| **çªå‘å¤„ç†** | ç¬é—´100ä¸ªï¼Œç«‹å³å…è®¸ | ç¬é—´100ä¸ªï¼Œç«‹å³å¤„ç† |
| **åç»­è¯·æ±‚** | 60ç§’åæ‰èƒ½å‘æ–°è¯·æ±‚ | æ¯10mså¯å‘1ä¸ªæ–°è¯·æ±‚ï¼ˆæŒç»­è¡¥å……ï¼‰ |
| **é€‚ç”¨åœºæ™¯** | ä¸¥æ ¼é™åˆ¶ï¼ˆç™»å½•ç­‰ï¼‰ | å…è®¸æŒç»­æµé‡ï¼ˆAPIç½‘å…³ï¼‰ |

**æ ¸å¿ƒå·®å¼‚**ï¼š
- sliding-windowï¼š100æ¬¡ç”¨å®Œåè¦ç­‰60ç§’
- token-bucketï¼š100æ¬¡ç”¨å®ŒåæŒ‰é€Ÿç‡æŒç»­è¡¥å……ï¼ˆæ¯10msè¡¥1ä¸ªï¼‰

**ç‰¹ç‚¹**ï¼š
- âœ… å…è®¸çªå‘ï¼šæ¡¶æ»¡æ—¶å¯ç¬é—´å¤„ç†capacityä¸ªè¯·æ±‚
- âœ… æŒç»­å¯ç”¨ï¼šæŒ‰refillRateæŒç»­è¡¥å……ä»¤ç‰Œ
- âœ… ç”¨æˆ·ä½“éªŒå¥½ï¼šä¸ä¼šé•¿æ—¶é—´å®Œå…¨é˜»å¡

**é€‚ç”¨**ï¼šAPIç½‘å…³ã€å…è®¸æŒç»­é«˜é¢‘è¯·æ±‚çš„åœºæ™¯

---

**4. leaky-bucketï¼ˆæ¼æ¡¶ï¼‰** - å¹³æ»‘æµé‡

```javascript
// é…ç½®ï¼šcapacity: 100, leakRate: 100 (æ¯ç§’æ¼100ä¸ª), windowMs: 1000
```

**å·¥ä½œæ–¹å¼**ï¼š
- è¯·æ±‚è¿›å…¥æ¡¶ï¼ˆä¸ç«‹å³å¤„ç†ï¼‰
- ä»¥æ’å®šé€Ÿç‡"æ¼å‡º"ï¼ˆå¤„ç†ï¼‰ï¼šæ¯ç§’100ä¸ª = æ¯10mså¤„ç†1ä¸ª
- æ¡¶æ»¡æ—¶æ‹’ç»æ–°è¯·æ±‚

**å®é™…è¡¨ç°**ï¼š
```
åœºæ™¯ï¼šç¬é—´å‘é€100ä¸ªè¯·æ±‚
0ms:    è¯·æ±‚1-100  â†’ æ”¾å…¥æ¡¶ âœ…ï¼ˆä¸æ˜¯ç«‹å³å¤„ç†ï¼ï¼‰
0ms:    å¼€å§‹ä»¥æ’å®šé€Ÿç‡æ¼å‡º
10ms:   å¤„ç†ç¬¬1ä¸ªè¯·æ±‚
20ms:   å¤„ç†ç¬¬2ä¸ªè¯·æ±‚
...
1000ms: å¤„ç†å®Œç¬¬100ä¸ªè¯·æ±‚

å¯¹æ¯” token-bucketï¼š
- token-bucketï¼š0msæ—¶ç«‹å³å¤„ç†å®Œ100ä¸ª âœ…
- leaky-bucketï¼š0-1000mså†…åŒ€é€Ÿå¤„ç†å®Œ ğŸŒ
```

**"æ’å®šé€Ÿç‡"çš„å…·ä½“å€¼**ï¼š
- é…ç½®ï¼šleakRate: 100, windowMs: 1000
- æ’å®šé€Ÿç‡ = æ¯ç§’æ¼å‡º100ä¸ª = æ¯10msæ¼1ä¸ª
- **è¿™å°±æ˜¯"æ’å®š"çš„å…·ä½“æ„æ€ï¼šæ¯10mså¤„ç†1ä¸ªè¯·æ±‚**

**ç‰¹ç‚¹**ï¼š
- âœ… æ’å®šè¾“å‡ºï¼šä¸¥æ ¼æŒ‰leakRateå¤„ç†ï¼ˆæ¯10mså¤„ç†1ä¸ªï¼‰
- âœ… å¹³æ»‘æµé‡ï¼šå‰Šå³°å¡«è°·ï¼Œä¿æŠ¤åç«¯
- âŒ ä½“éªŒç¨å·®ï¼šçªå‘è¯·æ±‚éœ€è¦æ’é˜Ÿç­‰å¾…ï¼ˆä¸æ˜¯ç«‹å³å¤„ç†ï¼‰

**é€‚ç”¨**ï¼šä¿æŠ¤åç«¯ç³»ç»Ÿã€éœ€è¦æ’å®šè¾“å‡ºé€Ÿç‡çš„åœºæ™¯

ğŸ“– **è¯¦ç»†æ–‡æ¡£**ï¼š
- [ç®—æ³•å¯¹æ¯”æŒ‡å—](./algorithms-comparison.md) - ä½¿ç”¨åœºæ™¯ã€é…ç½®ç¤ºä¾‹ã€é€‰æ‹©å†³ç­–
- [ç®—æ³•æ·±åº¦åˆ†æ](./algorithms-deep-analysis.md) - å®ç°åŸç†ã€ç¬æ—¶è¶…é¢‘åˆ†æ

---

### 4. store - å­˜å‚¨åç«¯ï¼ˆå¯é€‰ï¼‰

**è¯´æ˜**ï¼šå­˜å‚¨é™æµæ•°æ®çš„ä½ç½®

```javascript
// æ–¹å¼1ï¼šå†…å­˜å­˜å‚¨ï¼ˆé»˜è®¤ï¼Œå•æœåŠ¡å™¨ï¼‰
store: 'memory'

// æ–¹å¼2ï¼šRedisè¿æ¥å­—ç¬¦ä¸²
store: 'redis://localhost:6379'

// æ–¹å¼3ï¼šRedis Storeå®ä¾‹ï¼ˆæ¨èï¼‰
const Redis = require('ioredis');
const { RedisStore } = require('flex-rate-limit');

store: new RedisStore({
  client: new Redis({ host: '127.0.0.1', port: 6379 }),
  prefix: 'rl:',
})
```

**é»˜è®¤å€¼**ï¼š`'memory'`

**é€‰æ‹©å»ºè®®**ï¼š
- å•æœåŠ¡å™¨ï¼šä½¿ç”¨ `memory`ï¼ˆå¿«é€Ÿã€ç®€å•ï¼‰
- å¤šæœåŠ¡å™¨ï¼šä½¿ç”¨ `Redis`ï¼ˆåˆ†å¸ƒå¼ã€æ•°æ®å…±äº«ï¼‰

---

### 5. keyGenerator - é”®ç”Ÿæˆå™¨ï¼ˆå¯é€‰ï¼‰

**è¯´æ˜**ï¼šç”Ÿæˆå”¯ä¸€çš„é™æµé”®ï¼Œå†³å®š"æŒ‰ä»€ä¹ˆç»´åº¦é™æµ"

```javascript
// é¢„å®šä¹‰ç”Ÿæˆå™¨ï¼ˆå­—ç¬¦ä¸²ï¼‰
keyGenerator: 'ip'            // æŒ‰IPé™æµ
keyGenerator: 'userId'        // æŒ‰ç”¨æˆ·IDé™æµ
keyGenerator: 'userAndRoute'  // æŒ‰ç”¨æˆ·+è·¯ç”±é™æµï¼ˆä¸šåŠ¡é”ï¼‰â­

// è‡ªå®šä¹‰å‡½æ•°
keyGenerator: (req, context) => {
  const userId = req.user?.id || req.ip;
  const route = context?.route || req.path;
  return `user:${userId}:${route}`;
}
```

**é»˜è®¤å€¼**ï¼šæŒ‰IPé™æµ

**å¸¸è§åœºæ™¯**ï¼š
- æŒ‰IPï¼š`keyGenerators.ip`ï¼ˆå…¬å¼€APIï¼‰
- æŒ‰ç”¨æˆ·ï¼š`keyGenerators.userId`ï¼ˆç™»å½•åAPIï¼‰
- æŒ‰ç”¨æˆ·+è·¯ç”±ï¼š`keyGenerators.userAndRoute`ï¼ˆä¸šåŠ¡é”ï¼Œæ¨èï¼‰â­

ğŸ“– **è¯¦ç»†è¯´æ˜**ï¼š[business-lock-guide.md](./business-lock-guide.md)

---

### 6. å…¶ä»–é…ç½®é¡¹

```javascript
const limiter = new RateLimiter({
  // ... æ ¸å¿ƒé…ç½®

  // è·³è¿‡ç‰¹å®šè¯·æ±‚ï¼ˆå¦‚å¥åº·æ£€æŸ¥ï¼‰
  skip: (req) => req.path === '/health',
  
  // è·¯ç”±çº§åˆ«é…ç½®ï¼ˆè¦†ç›–å…¨å±€é…ç½®ï¼‰
  perRoute: {
    '/api/login': { max: 5, windowMs: 15 * 60 * 1000 },
    '/api/query': { max: 200, windowMs: 60 * 1000 },
  },
  
  // è‡ªå®šä¹‰é™æµå“åº”
  handler: (req, res) => {
    res.status(429).json({ 
      error: 'è¯·æ±‚è¿‡å¤šï¼Œè¯·ç¨åå†è¯•',
      retryAfter: 60,
    });
  },
  
  // æ˜¯å¦æ·»åŠ å“åº”å¤´ï¼ˆX-RateLimit-*ï¼‰
  headers: true,
  
  // æ˜¯å¦è·³è¿‡æˆåŠŸ/å¤±è´¥è¯·æ±‚çš„è®¡æ•°
  skipSuccessfulRequests: false,
  skipFailedRequests: false,
});
```

---

## å®Œæ•´é…ç½®ç¤ºä¾‹

```javascript
const { RateLimiter } = require('flex-rate-limit');

const limiter = new RateLimiter({
  // æ ¸å¿ƒé…ç½®
  windowMs: 60 * 1000,           // 1åˆ†é’Ÿ
  max: 100,                      // æœ€å¤š100æ¬¡
  algorithm: 'sliding-window',   // æ»‘åŠ¨çª—å£
  
  // å­˜å‚¨é…ç½®
  store: 'memory',               // å†…å­˜å­˜å‚¨
  
  // é”®ç”Ÿæˆå™¨ï¼ˆä¸šåŠ¡é”ï¼šç”¨æˆ·+è·¯ç”±ï¼‰
  keyGenerator: (ctx, context) => {
    const userId = ctx.user?.id || ctx.ip;
    return `user:${userId}:${context?.route || ctx.path}`;
  },
  
  // å¯é€‰é…ç½®
  headers: true,                 // æ·»åŠ å“åº”å¤´
  skip: (req) => req.path === '/health',  // è·³è¿‡å¥åº·æ£€æŸ¥
});
```

---

## å‚æ•°é€ŸæŸ¥è¡¨

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| windowMs | number | 60000 | æ—¶é—´çª—å£å¤§å°ï¼ˆæ¯«ç§’ï¼‰ |
| max | number \| function | 100 | æœ€å¤§è¯·æ±‚æ•°æˆ–åŠ¨æ€å‡½æ•° |
| algorithm | string | 'sliding-window' | é™æµç®—æ³• |
| store | string \| object | 'memory' | å­˜å‚¨åç«¯ |
| keyGenerator | string \| function | æŒ‰IP | é”®ç”Ÿæˆå™¨ |
| skip | function | () => false | è·³è¿‡æ£€æŸ¥çš„æ¡ä»¶ |
| perRoute | object | {} | è·¯ç”±çº§åˆ«é…ç½® |
| handler | function | null | è‡ªå®šä¹‰å¤„ç†å™¨ |
| headers | boolean | true | æ˜¯å¦æ·»åŠ å“åº”å¤´ |
| skipSuccessfulRequests | boolean | false | è·³è¿‡æˆåŠŸè¯·æ±‚ |
| skipFailedRequests | boolean | false | è·³è¿‡å¤±è´¥è¯·æ±‚ |

---

## å®æˆ˜é…ç½®åœºæ™¯

### åœºæ™¯1ï¼šç™»å½•ä¿æŠ¤ï¼ˆä¸¥æ ¼é™åˆ¶ï¼‰â­â­â­

```javascript
const loginLimiter = new RateLimiter({
  windowMs: 15 * 60 * 1000,  // 15åˆ†é’Ÿ
  max: 5,                     // â­ æœ€å¤š5æ¬¡ï¼ˆé˜²æš´åŠ›ç ´è§£ï¼‰
  keyGenerator: 'ip',         // æŒ‰IPé™åˆ¶
  handler: (req, res) => {
    res.status(429).json({
      error: 'ç™»å½•å°è¯•è¿‡å¤šï¼Œè¯·15åˆ†é’Ÿåå†è¯•',
    });
  },
});
```

### åœºæ™¯2ï¼šæ•æ„Ÿæ“ä½œï¼ˆä¸­ç­‰é™åˆ¶ï¼‰

```javascript
const sensitiveOpLimiter = new RateLimiter({
  windowMs: 60 * 60 * 1000,   // 1å°æ—¶
  max: 10,                     // â­ æœ€å¤š10æ¬¡ï¼ˆä¿®æ”¹å¯†ç ã€æ”¯ä»˜ç­‰ï¼‰
  keyGenerator: 'userId',      // æŒ‰ç”¨æˆ·é™åˆ¶
});
```

### åœºæ™¯3ï¼šæ•°æ®ä¿®æ”¹ï¼ˆæ™®é€šé™åˆ¶ï¼‰

```javascript
const mutationLimiter = new RateLimiter({
  windowMs: 60 * 60 * 1000,   // 1å°æ—¶
  max: 50,                     // â­ æœ€å¤š50æ¬¡ï¼ˆåˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ï¼‰
  keyGenerator: 'userAndRoute', // æŒ‰ç”¨æˆ·+è·¯ç”±é™åˆ¶ï¼ˆä¸šåŠ¡é”ï¼‰
});
```

### åœºæ™¯4ï¼šAPIæŸ¥è¯¢ï¼ˆå®½æ¾é™åˆ¶ï¼‰

```javascript
const queryLimiter = new RateLimiter({
  windowMs: 60 * 1000,        // 1åˆ†é’Ÿ
  max: 100,                    // â­ æœ€å¤š100æ¬¡ï¼ˆåˆ—è¡¨ã€è¯¦æƒ…æŸ¥è¯¢ï¼‰
  keyGenerator: 'userAndRoute',
});
```

### åœºæ™¯5ï¼šå…¬å¼€APIï¼ˆé«˜é¢‘é™åˆ¶ï¼‰

```javascript
const publicApiLimiter = new RateLimiter({
  windowMs: 60 * 60 * 1000,   // 1å°æ—¶
  max: 1000,                   // â­ æœ€å¤š1000æ¬¡ï¼ˆå…¬å¼€æ¥å£ï¼‰
  keyGenerator: (req) => req.apiKey || req.ip,
});
```

### åœºæ™¯6ï¼šç”¨æˆ·ç­‰çº§åˆ†çº§

```javascript
const tieredLimiter = new RateLimiter({
  windowMs: 60 * 60 * 1000,
  max: async (req) => {
    const tier = req.user?.tier || 'free';
    return {
      free: 100,        // â­ å…è´¹ç”¨æˆ·
      basic: 500,       // â­ åŸºç¡€ä¼šå‘˜
      premium: 2000,    // â­ é«˜çº§ä¼šå‘˜
      enterprise: 10000,// â­ ä¼ä¸šç”¨æˆ·
    }[tier];
  },
  keyGenerator: 'userId',
});
```

### åœºæ™¯7ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿï¼ˆRedisï¼‰

```javascript
const Redis = require('ioredis');
const { RateLimiter, RedisStore } = require('flex-rate-limit');

const distributedLimiter = new RateLimiter({
  windowMs: 60 * 1000,
  max: 100,
  store: new RedisStore({
    client: new Redis('redis://redis-server:6379'),
    prefix: 'rl:',
  }),
});
```

---

## æ¨èé…ç½®é€ŸæŸ¥è¡¨

| åœºæ™¯ | windowMs | max | è¯´æ˜ |
|------|----------|-----|------|
| **ç™»å½•/æ³¨å†Œ** | 15åˆ†é’Ÿ | 5 | ä¸¥æ ¼é™åˆ¶ï¼Œé˜²æš´åŠ›ç ´è§£ â­â­â­ |
| **ä¿®æ”¹å¯†ç ** | 1å°æ—¶ | 10 | æ•æ„Ÿæ“ä½œ |
| **æ”¯ä»˜æ“ä½œ** | 1å°æ—¶ | 10 | æ•æ„Ÿæ“ä½œ |
| **æ•°æ®ä¿®æ”¹** | 1å°æ—¶ | 50 | åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ |
| **APIæŸ¥è¯¢** | 1åˆ†é’Ÿ | 100 | åˆ—è¡¨ã€è¯¦æƒ…ç­‰ |
| **æœç´¢æ¥å£** | 1åˆ†é’Ÿ | 200 | é«˜é¢‘æŸ¥è¯¢ |
| **å…¬å¼€API** | 1å°æ—¶ | 1000 | å¼€æ”¾æ¥å£ |
| **WebSocket** | 1åˆ†é’Ÿ | 500 | å®æ—¶é€šä¿¡ |

---

## Redis å­˜å‚¨é…ç½®

```javascript
const Redis = require('ioredis');
const { RateLimiter, RedisStore } = require('flex-rate-limit');

const redis = new Redis({
  host: 'localhost',
  port: 6379,
  db: 0, // Redis æ•°æ®åº“ç¼–å·
  password: 'your-password', // å¦‚æœéœ€è¦å¯†ç 
});

const limiter = new RateLimiter({
  windowMs: 15 * 60 * 1000,
  max: 100,
  store: new RedisStore({
    client: redis,
    prefix: 'rl:', // é”®å‰ç¼€ï¼ˆé¿å…é”®å†²çªï¼‰
    expiry: 3600, // æ•°æ®è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
  }),
});
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

**ä¸‹ä¸€æ­¥é˜…è¯»**ï¼š
- ğŸ“– [é«˜çº§ç”¨æ³•](./advanced.md) - è·¯ç”±çº§é™æµã€åŠ¨æ€é…ç½®
- ğŸ“– [ç®—æ³•å¯¹æ¯”æŒ‡å—](./algorithms-comparison.md) - æ·±å…¥ç†è§£ç®—æ³•é€‰æ‹©

**ç›¸å…³ä¸»é¢˜**ï¼š
- ğŸ“– [ä¸šåŠ¡é”æŒ‡å—](./business-lock-guide.md) - keyGeneratorè¯¦è§£
- ğŸ“– [å­˜å‚¨åç«¯](./storage.md) - Redisé…ç½®å’Œæ€§èƒ½å¯¹æ¯”
- ğŸ“– [å¿«é€Ÿå¼€å§‹](./quickstart.md) - åŸºç¡€ç”¨æ³•

**è¿”å›**ï¼š
- ğŸ“– [æ–‡æ¡£ä¸­å¿ƒ](./README.md) - æŸ¥çœ‹æ‰€æœ‰æ–‡æ¡£å’Œå­¦ä¹ è·¯å¾„
  }),
});
```






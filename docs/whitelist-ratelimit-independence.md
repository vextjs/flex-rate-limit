# ç™½åå•ä¸é™æµç‹¬ç«‹æ€§è¯´æ˜æ–‡æ¡£

## ğŸ“Š æ ¸å¿ƒé—®é¢˜

**ç”¨æˆ·éœ€æ±‚**ï¼šç™½åå•å’Œé™æµå¿…é¡»æ˜¯**å®Œå…¨ç‹¬ç«‹**çš„ä¸¤ä¸ªåŠŸèƒ½ï¼Œä¸æ˜¯è€¦åˆçš„ã€‚

- **ç™½åå•**ï¼šè®¿é—®æ§åˆ¶ï¼ˆIP ä¸åœ¨ç™½åå• â†’ 403 Forbiddenï¼‰
- **é™æµ**ï¼šé€Ÿç‡æ§åˆ¶ï¼ˆè¯·æ±‚è¶…é™ â†’ 429 Too Many Requestsï¼‰
- **ç‹¬ç«‹æ€§**ï¼šå³ä½¿ IP åœ¨ç™½åå•å†…ï¼Œä¹Ÿè¦å—åˆ°é™æµé™åˆ¶

---

## âš¡ å¿«é€Ÿå‚è€ƒï¼šé…ç½®åœºæ™¯

### åœºæ™¯å¯¹æ¯”è¡¨

| é…ç½®æƒ…å†µ | å¤„ç†ç»“æœ | æ¨èåº¦ |
|---------|---------|--------|
| **åªé…ç½®é™æµ** | æ‰€æœ‰ IP å¯è®¿é—® + é™æµ | â­â­â­ é€‚åˆå…¬å¼€ API |
| **åªé…ç½®ç™½åå•** | ç™½åå• IP æ— é™åˆ¶è®¿é—® | âŒ ä¸æ¨è |
| **ç™½åå• + é™æµ** | ç™½åå•éªŒè¯ â†’ é™æµæ£€æŸ¥ | â­â­â­ æœ€æ¨è |
| **å…¨å±€ç™½åå•** | æ‰€æœ‰è·¯ç”±é€šç”¨ + å„è‡ªé™æµ | â­â­â­ æ¨è |

**è¯¦ç»†è¯´æ˜**: [é…ç½®åœºæ™¯è¯¦è§£](./whitelist-ratelimit-config-scenarios.md)

### å…³é”®è¦ç‚¹

1. **æœªé…ç½®ç™½åå• = å…è®¸æ‰€æœ‰ IP**ï¼ˆä¸æ˜¯æ‹’ç»æ‰€æœ‰ï¼‰
2. **ç™½åå• IP ä¹Ÿä¼šè¢«é™æµ**ï¼ˆç‹¬ç«‹ç‰ˆæœ¬ï¼‰
3. **å…¨å±€ç™½åå•ä¼˜å…ˆçº§æ›´é«˜**ï¼ˆä½†ä»éœ€é™æµæ£€æŸ¥ï¼‰
4. **æ¨èé…ç½®ï¼šç™½åå• + é™æµ**ï¼ˆåŒé‡ä¿æŠ¤ï¼‰

---

## âŒ é”™è¯¯å®ç°ï¼ˆè€¦åˆç‰ˆæœ¬ï¼‰

### é—®é¢˜ä»£ç 

ä¹‹å‰çš„ `express-ip-whitelist-advanced.js` ç­‰æ–‡ä»¶ä¸­ï¼š

```javascript
function createRouteLimiter(route, options = {}) {
  return new RateLimiter({
    windowMs: options.windowMs || 60 * 1000,
    max: options.max || 50,
    skip: (req) => {
      const clientIP = req.ip || req.socket?.remoteAddress;
      
      // âŒ é—®é¢˜ï¼šç™½åå• IP è·³è¿‡äº†é™æµ
      if (ipConfig.isGlobalWhitelisted(clientIP)) {
        return true; // è·³è¿‡é™æµ
      }
      
      if (ipConfig.isRouteWhitelisted(route, clientIP)) {
        return true; // è·³è¿‡é™æµ
      }
      
      return false;
    },
  });
}
```

### é—®é¢˜åˆ†æ

| é—®é¢˜ | æè¿° | åæœ |
|------|------|------|
| **è€¦åˆ** | ç™½åå•æ£€æŸ¥æ··åœ¨é™æµå™¨çš„ `skip` ä¸­ | ç™½åå•å’Œé™æµä¸ç‹¬ç«‹ |
| **è·³è¿‡é™æµ** | ç™½åå• IP ä½¿ç”¨ `skip: true` è·³è¿‡é™æµ | ç™½åå• IP ä¸å—é™æµæ§åˆ¶ |
| **åŠŸèƒ½æ··æ·†** | ä¸€ä¸ªé…ç½®åŒæ—¶æ§åˆ¶ä¸¤ä¸ªåŠŸèƒ½ | æ— æ³•ç‹¬ç«‹é…ç½®ç™½åå•å’Œé™æµ |

### å®é™…æ•ˆæœ

```
ç™½åå• IP:
  â†’ skip: true â†’ å®Œå…¨è·³è¿‡é™æµ âŒ
  â†’ æ— é™åˆ¶è®¿é—® âŒ

éç™½åå• IP:
  â†’ skip: false â†’ åº”ç”¨é™æµ âœ…
  â†’ å—åˆ°é™æµé™åˆ¶ âœ…
```

**ç»“è®º**ï¼šç™½åå• IP ä¸å—é™æµæ§åˆ¶ï¼Œä¸¤è€…æ˜¯è€¦åˆçš„ âŒ

---

## âœ… æ­£ç¡®å®ç°ï¼ˆç‹¬ç«‹ç‰ˆæœ¬ï¼‰

### æ ¸å¿ƒåŸåˆ™

```
è¯·æ±‚ â†’ [ç™½åå•ä¸­é—´ä»¶] â†’ [é™æµä¸­é—´ä»¶] â†’ [ä¸šåŠ¡å¤„ç†]
         â†“ ä¸åœ¨ç™½åå•      â†“ è¶…é™
       403 Forbidden    429 Too Many
```

**ä¸¤ä¸ªç‹¬ç«‹çš„ä¸­é—´ä»¶**ï¼š
1. **ç™½åå•ä¸­é—´ä»¶**ï¼šåªè´Ÿè´£éªŒè¯ IP
2. **é™æµä¸­é—´ä»¶**ï¼šåªè´Ÿè´£é€Ÿç‡æ§åˆ¶

### å®ç°ä»£ç 

#### 1. ç™½åå•ä¸­é—´ä»¶ï¼ˆç‹¬ç«‹ï¼‰

```javascript
/**
 * IP ç™½åå•éªŒè¯ä¸­é—´ä»¶
 * - åªè´Ÿè´£éªŒè¯ IP æ˜¯å¦åœ¨ç™½åå•
 * - ä¸åœ¨ç™½åå• â†’ 403 Forbidden
 * - åœ¨ç™½åå• â†’ ç»§ç»­æ‰§è¡Œï¼ˆåŒ…æ‹¬é™æµæ£€æŸ¥ï¼‰
 */
function ipWhitelistMiddleware(route) {
  return (req, res, next) => {
    const clientIP = req.ip || req.socket?.remoteAddress;

    // æ£€æŸ¥å…¨å±€ç™½åå•
    if (ipConfig.isGlobalWhitelisted(clientIP)) {
      return next(); // âœ… é€šè¿‡éªŒè¯ï¼Œç»§ç»­åˆ°é™æµ
    }

    // æ£€æŸ¥è·¯ç”±ç™½åå•
    if (ipConfig.isRouteWhitelisted(route, clientIP)) {
      return next(); // âœ… é€šè¿‡éªŒè¯ï¼Œç»§ç»­åˆ°é™æµ
    }

    // âŒ ä¸åœ¨ç™½åå•ï¼Œæ‹’ç»è®¿é—®
    res.status(403).json({
      error: 'è®¿é—®è¢«æ‹’ç»',
      message: 'åªæœ‰æˆæƒçš„ IP åœ°å€å¯ä»¥è®¿é—®æ­¤èµ„æº',
      ip: clientIP,
    });
  };
}
```

#### 2. é™æµä¸­é—´ä»¶ï¼ˆç‹¬ç«‹ï¼‰

```javascript
/**
 * é™æµä¸­é—´ä»¶
 * - åªè´Ÿè´£é€Ÿç‡é™åˆ¶
 * - ä¸æ£€æŸ¥ç™½åå•ï¼ˆç™½åå•ç”±ç‹¬ç«‹ä¸­é—´ä»¶å¤„ç†ï¼‰
 * - è¶…è¿‡é™é¢ â†’ 429 Too Many Requests
 */
function createRateLimiter(options = {}) {
  const limiter = new RateLimiter({
    windowMs: options.windowMs || 60 * 1000,
    max: options.max || 100,
    // âš ï¸ æ³¨æ„ï¼šä¸ä½¿ç”¨ skipï¼Œæ‰€æœ‰è¯·æ±‚éƒ½è¦é™æµ
  });

  return limiter.middleware();
}
```

#### 3. ç»„åˆä½¿ç”¨

```javascript
// ç®¡ç†åå°ï¼šç™½åå• + é™æµï¼ˆå®Œå…¨ç‹¬ç«‹ï¼‰
const adminWhitelist = ipWhitelistMiddleware('/api/admin');
const adminLimiter = createRateLimiter({ max: 200 });

app.get('/api/admin/users',
  adminWhitelist,  // ç¬¬ä¸€å±‚ï¼šç™½åå•éªŒè¯ï¼ˆ403ï¼‰
  adminLimiter,    // ç¬¬äºŒå±‚ï¼šé™æµæ§åˆ¶ï¼ˆ429ï¼‰
  (req, res) => {
    // ä¸šåŠ¡å¤„ç†
  }
);
```

### å®é™…æ•ˆæœ

```
ç™½åå• IPï¼ˆ200æ¬¡/åˆ†é’Ÿé™æµï¼‰:
  è¯·æ±‚ 1-200:
    â†’ ç™½åå•éªŒè¯ âœ… â†’ é™æµæ£€æŸ¥ âœ… â†’ 200 OK
  
  è¯·æ±‚ 201+:
    â†’ ç™½åå•éªŒè¯ âœ… â†’ é™æµæ£€æŸ¥ âŒ â†’ 429 Too Many Requests

éç™½åå• IP:
  ä»»ä½•è¯·æ±‚:
    â†’ ç™½åå•éªŒè¯ âŒ â†’ 403 Forbiddenï¼ˆä¸ä¼šåˆ°è¾¾é™æµæ£€æŸ¥ï¼‰
```

**ç»“è®º**ï¼šç™½åå• IP ä¹Ÿå—é™æµæ§åˆ¶ï¼Œä¸¤è€…å®Œå…¨ç‹¬ç«‹ âœ…

---

## ğŸ“‹ å¯¹æ¯”è¡¨æ ¼

| ç‰¹æ€§ | è€¦åˆç‰ˆæœ¬ âŒ | ç‹¬ç«‹ç‰ˆæœ¬ âœ… |
|------|-----------|-----------|
| **ç™½åå• IP æ˜¯å¦é™æµ** | âŒ ä¸é™æµï¼ˆskip: trueï¼‰ | âœ… é™æµï¼ˆç‹¬ç«‹ä¸­é—´ä»¶ï¼‰ |
| **æ‰§è¡Œé¡ºåº** | é™æµå™¨å†…éƒ¨æ£€æŸ¥ç™½åå• | ç™½åå• â†’ é™æµï¼ˆé¡ºåºæ˜ç¡®ï¼‰ |
| **é…ç½®ç‹¬ç«‹æ€§** | âŒ æ··åœ¨ä¸€èµ· | âœ… å®Œå…¨ç‹¬ç«‹ |
| **åŠŸèƒ½æ¸…æ™°åº¦** | âŒ æ··æ·† | âœ… æ¸…æ™° |
| **æµ‹è¯•éš¾åº¦** | âŒ éš¾æµ‹è¯• | âœ… æ˜“æµ‹è¯• |

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯ 1: ç™½åå• IP è¢«é™æµ

```bash
# å¿«é€Ÿè¯·æ±‚æµ‹è¯•æ¥å£ 6 æ¬¡ï¼ˆé™æµ 5 æ¬¡/åˆ†é’Ÿï¼‰
for i in {1..6}; do
  curl http://localhost:3500/api/test/independence
  echo ""
done
```

**é¢„æœŸç»“æœ**ï¼ˆç‹¬ç«‹ç‰ˆæœ¬ï¼‰ï¼š
```
è¯·æ±‚ 1: 200 OK - {"remaining": 4}
è¯·æ±‚ 2: 200 OK - {"remaining": 3}
è¯·æ±‚ 3: 200 OK - {"remaining": 2}
è¯·æ±‚ 4: 200 OK - {"remaining": 1}
è¯·æ±‚ 5: 200 OK - {"remaining": 0}
è¯·æ±‚ 6: 429 Too Many Requests âœ…
```

**é”™è¯¯ç»“æœ**ï¼ˆè€¦åˆç‰ˆæœ¬ï¼‰ï¼š
```
è¯·æ±‚ 1-6: å…¨éƒ¨ 200 OKï¼ˆæ— é™åˆ¶ï¼‰âŒ
```

### æµ‹è¯•åœºæ™¯ 2: éç™½åå• IP

```bash
# ä½¿ç”¨éç™½åå• IP è®¿é—®
curl http://localhost:3500/api/admin/users
```

**é¢„æœŸç»“æœ**ï¼ˆä¸¤ä¸ªç‰ˆæœ¬ä¸€è‡´ï¼‰ï¼š
```
403 Forbidden
{
  "error": "è®¿é—®è¢«æ‹’ç»",
  "message": "åªæœ‰æˆæƒçš„ IP åœ°å€å¯ä»¥è®¿é—®æ­¤èµ„æº"
}
```

---

## ğŸ“ æ–‡ä»¶å¯¹æ¯”

| æ–‡ä»¶ç±»å‹ | æ–‡ä»¶å | ç‰¹ç‚¹ | æ¨è |
|---------|--------|------|------|
| **è€¦åˆç‰ˆæœ¬** | `express-ip-whitelist-advanced.js` | ç™½åå•è·³è¿‡é™æµ | âŒ |
| **è€¦åˆç‰ˆæœ¬** | `koa-ip-whitelist-advanced.js` | ç™½åå•è·³è¿‡é™æµ | âŒ |
| **ç‹¬ç«‹ç‰ˆæœ¬** | `express-ip-whitelist-independent.js` | ç™½åå• + é™æµç‹¬ç«‹ | âœ… |
| **ç‹¬ç«‹ç‰ˆæœ¬** | `koa-ip-whitelist-independent.js` | ç™½åå• + é™æµç‹¬ç«‹ | âœ… |

---

## ğŸ¯ ä½¿ç”¨å»ºè®®

### åœºæ™¯ 1: å…¬å¼€ API

**éœ€æ±‚**ï¼šæ‰€æœ‰äººå¯ä»¥è®¿é—®ï¼Œä½†æœ‰é™æµ

**é…ç½®**ï¼š
```javascript
// ä¸éœ€è¦ç™½åå•ä¸­é—´ä»¶
app.get('/api/public/data',
  createRateLimiter({ max: 100 }),  // åªéœ€è¦é™æµ
  handler
);
```

### åœºæ™¯ 2: ç®¡ç†åå°

**éœ€æ±‚**ï¼šåªå…è®¸åŠå…¬å®¤ IPï¼Œä¸”æœ‰é™æµ

**é…ç½®**ï¼š
```javascript
// éœ€è¦ç™½åå• + é™æµï¼ˆç‹¬ç«‹ï¼‰
app.get('/api/admin/users',
  ipWhitelistMiddleware('/api/admin'),  // ç™½åå•éªŒè¯
  createRateLimiter({ max: 200 }),      // é™æµæ§åˆ¶
  handler
);
```

### åœºæ™¯ 3: å†…éƒ¨ API

**éœ€æ±‚**ï¼šåªå…è®¸å†…ç½‘ IP æ®µï¼Œé«˜é™æµ

**é…ç½®**ï¼š
```javascript
// IP æ®µç™½åå• + é«˜é™æµ
app.get('/api/internal/stats',
  ipWhitelistMiddleware('/api/internal'),  // IP æ®µéªŒè¯
  createRateLimiter({ max: 5000 }),        // é«˜é™æµ
  handler
);
```

### åœºæ™¯ 4: ä¸åŒæ“ä½œä¸åŒé™æµ

**éœ€æ±‚**ï¼šåŒä¸€ç™½åå•ï¼Œä¸åŒæ“ä½œä¸åŒé™æµ

**é…ç½®**ï¼š
```javascript
// æ•æ„Ÿæ“ä½œï¼šä½é™æµ
app.post('/api/secure/delete',
  ipWhitelistMiddleware('/api/secure'),  // å…±äº«ç™½åå•
  createRateLimiter({ max: 10 }),        // ä½é™æµ
  handler
);

// æŸ¥è¯¢æ“ä½œï¼šé«˜é™æµ
app.get('/api/secure/query',
  ipWhitelistMiddleware('/api/secure'),  // å…±äº«ç™½åå•
  createRateLimiter({ max: 1000 }),      // é«˜é™æµ
  handler
);
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### Express ç‹¬ç«‹ç‰ˆæœ¬

```bash
cd E:\MySelf\rate-limit

# å¯åŠ¨æœåŠ¡ï¼ˆç«¯å£ 3500ï¼‰
GLOBAL_IP_WHITELIST=127.0.0.1 \
ADMIN_IP_WHITELIST=192.168.1.10,192.168.1.11 \
node examples/express-ip-whitelist-independent.js

# æµ‹è¯•ç‹¬ç«‹æ€§
for i in {1..6}; do
  curl http://localhost:3500/api/test/independence
  echo ""
done
```

### Koa ç‹¬ç«‹ç‰ˆæœ¬

```bash
# å¯åŠ¨æœåŠ¡ï¼ˆç«¯å£ 3501ï¼‰
PORT=3501 GLOBAL_IP_WHITELIST=127.0.0.1 \
node examples/koa-ip-whitelist-independent.js

# æµ‹è¯•
for i in {1..6}; do
  curl http://localhost:3501/api/test/independence
  echo ""
done
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **Express ç‹¬ç«‹ç‰ˆæœ¬**: `examples/express-ip-whitelist-independent.js`
- **Koa ç‹¬ç«‹ç‰ˆæœ¬**: `examples/koa-ip-whitelist-independent.js`
- **è€¦åˆç‰ˆæœ¬ï¼ˆå‚è€ƒï¼‰**: `examples/express-ip-whitelist-advanced.js`

---

## âœ… æ€»ç»“

### æ ¸å¿ƒåŒºåˆ«

| æ–¹é¢ | è€¦åˆç‰ˆæœ¬ | ç‹¬ç«‹ç‰ˆæœ¬ |
|------|---------|---------|
| **ç™½åå• IP é™æµ** | âŒ ä¸é™æµ | âœ… é™æµ |
| **å®ç°æ–¹å¼** | å•ä¸ªä¸­é—´ä»¶ï¼ˆskipï¼‰ | ä¸¤ä¸ªç‹¬ç«‹ä¸­é—´ä»¶ |
| **é…ç½®çµæ´»æ€§** | âŒ ä½ | âœ… é«˜ |
| **åŠŸèƒ½æ¸…æ™°åº¦** | âŒ æ··æ·† | âœ… æ¸…æ™° |
| **æ¨èä½¿ç”¨** | âŒ ä¸æ¨è | âœ… æ¨è |

### å…³é”®ç‚¹

1. âœ… **ç™½åå•ä¸­é—´ä»¶**ï¼šåªè´Ÿè´£éªŒè¯ IPï¼ˆ403ï¼‰
2. âœ… **é™æµä¸­é—´ä»¶**ï¼šåªè´Ÿè´£é€Ÿç‡æ§åˆ¶ï¼ˆ429ï¼‰
3. âœ… **å®Œå…¨ç‹¬ç«‹**ï¼šç™½åå• IP ä¹Ÿä¼šè¢«é™æµ
4. âœ… **é¡ºåºæ¸…æ™°**ï¼šç™½åå• â†’ é™æµ â†’ ä¸šåŠ¡

### æ¨èä½¿ç”¨

- âœ… ä½¿ç”¨ `express-ip-whitelist-independent.js`
- âœ… ä½¿ç”¨ `koa-ip-whitelist-independent.js`
- âŒ é¿å…ä½¿ç”¨è€¦åˆç‰ˆæœ¬

---

**æ–‡æ¡£åˆ›å»ºæ—¶é—´**: 2026-02-05  
**ç‰ˆæœ¬**: v1.0  
**çŠ¶æ€**: âœ… å®Œæˆ
